{% extends 'MSDCoreBundle::layout.html.twig' %}

{% form_theme form with 'MSDCoreBundle:Form:fields.html.twig' %}

{% block content %}
    {{ form_start(form, { 'attr': {'id': 'connectionForm', 'action': path('msd_admin_user_edit_connection', {'userId': user.id }), 'class': 'form', 'rule': 'form', 'novalidate': 'novalidate'}}) }}
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div class="panel panel-default">
                    {{ form_widget(form.driver) }}
                    <input type="hidden" name="connectionId" value="{{ connection.id }}">
                    <div class="panel-heading">
                        <h4 class="panel-title">{% trans %}Server{% endtrans %}</h4>
                    </div>
                    <div class="panel-body">
                        {{ form_row(form.host) }}
                        {{ form_row(form.port) }}
                        {{ form_row(form.unixSocket) }}
                        {{ form_row(form.path) }}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">{% trans %}Credentials{% endtrans %}</h4>
                    </div>
                    <div class="panel-body">
                        {{ form_row(form.user) }}
                        {{ form_row(form.password) }}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">{% trans %}Credentials{% endtrans %}</h4>
                    </div>
                    <div class="panel-body">
                        {{ form_row(form.dbName) }}
                        {{ form_row(form.charset) }}
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-5">
                {{ form_row(form.save, {'attr': {'class': 'btn btn-primary btn-block btn-lg', 'onclick': "checkConnection(); return false;"} }) }}
            </div>
            <div class="col-md-2"></div>
        </div>
    </div>
    {{ form_end(form) }}
    <div class="modal fade" id="connectionError" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>{% trans %}Error{% endtrans %}</h3>
                </div>
                <div class="modal-body">
                    <p>Can't connect with your submitted connection information!</p>
                    <p>Please check your settings and credentials.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
<script type="text/javascript">
    var $errorModal = $('#connectionError').modal({
        "show":false
    });
    function checkConnection()
    {
        var $overlay = $('<div class="modal-backdrop fade in" style="display:none;z-index:1040;"><\/div>'),
            $loaderImg = $('<div class="modal fade in" style="width:100px;margin:40px auto;display:none;overflow:hidden;"><img src="{{ asset('bundles/msdcore/images/ajax-loader-loading-big.gif') }}"></div>');
        $overlay.appendTo('body').fadeIn();
        $loaderImg.appendTo('body').fadeIn();
        var $form = $('#connectionForm');
        $.ajax({
            type: "POST",
            url: "{{ path('msd_admin_user_connection_check') }}",
            data: $form.serialize(),
            success: function(response) {

                if (response.success) {
                    $loaderImg.fadeOut().remove();
                    $overlay.fadeOut().remove();
                    $form.submit();
                } else {
                    $errorModal.modal('show');
                }
            }
        });
    }
</script>
{% endblock %}